machine:
  environment:
    BUILD_VERSION:
      1.0.0
    BUILD_TARGET:
      webapp
  timezone:
    Asia/Tokyo
  java:
    version:
      openjdk8

dependencies:
  override:
    - mvn -B -f ${BUILD_TARGET}/pom.xml clean package findbugs:findbugs pmd:pmd -Dbuild.number=${CIRCLE_BUILD_NUM} -Pdeploy -Dmaven.test.skip=true

test:
  override:
    - echo "No Test(copy ${BUILD_TARGET} war)"
    - cp ${BUILD_TARGET}/appExample01/target/appExample01.war ${BUILD_TARGET}/target/
    - cp ${BUILD_TARGET}/appExample02/target/appExample02.war ${BUILD_TARGET}/target/

deployment:
  staging:
    branch: /develop\/.*/
    commands:
      - echo "${BUILD_VERSION} deployment"
      - git clone https://github.com/public-test-circleci/module-all.git
      - cd module-all && git checkout release/${BUILD_VERSION}
      - cp -f ${BUILD_TARGET}/target/*.war module-all/${BUILD_TARGET}/
      - cd module-all && git config --global user.email li@exgen.co.jp
      - cd module-all && git config --global user.name li-exgen
      - cd module-all && git commit -am "deploy from CircleCI(Number:${CIRCLE_BUILD_NUM})"
      - cd module-all && git push origin release/${BUILD_VERSION}

general:
  branches:
    only:
      - /develop\/.*/
